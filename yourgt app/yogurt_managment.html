<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é…¸å¥¶åº“å­˜ä¸é”€å”®ç®¡ç†ç³»ç»Ÿ v5.7</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Phosphor Icons for better UX. Add this if needed. -->
  <!-- <script src="https://unpkg.com/@phosphor-icons/web@2.0.3/dist/phosphor.js"></script> -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  ```html <script> 
  // Register Service Worker if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js') .then(registration => { console.log('ServiceWorker registration successful with scope: ', registration.scope); }) .catch(err => { console.log('ServiceWorker registration failed: ', err); }); }); } 
  </script>
</head>
<body class="bg-gray-50 text-gray-900 p-4 font-sans antialiased">
  <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-lg p-6">
    <h1 class="text-3xl font-extrabold text-center text-blue-800 mb-6">é…¸å¥¶åº“å­˜ä¸é”€å”®ç®¡ç†ç³»ç»Ÿ v5.7
      
    </h1>

    <!-- Top Navigation Buttons -->
    <div class="flex flex-wrap justify-center gap-3 mb-6 border-b pb-4 border-gray-200">
      <button onclick="showPage('daily-data-page', this)" class="btn-tab active" data-page-id="daily-data-page">ğŸ“ æ¯æ—¥æ•°æ®</button>
      <button onclick="showPage('inventory-settings-page', this)" class="btn-tab" data-page-id="inventory-settings-page">ğŸ› ï¸ åº“å­˜è®¾ç½®</button>
      <button onclick="showPage('restock-page', this)" class="btn-tab" data-page-id="restock-page">ğŸ›’ åŸææ–™è¿›è´§</button>
      <button onclick="showPage('history-charts-page', this)" class="btn-tab" data-page-id="history-charts-page">ğŸ“ˆ å†å²ä¸å›¾è¡¨</button>
    </div>

    <!-- Pages Container -->
    <div id="pages-container">

      <!-- Daily Data Page -->
      <div id="daily-data-page" class="page-content">
        <div class="mb-4 p-4 bg-gray-100 rounded-lg">
          <label for="report-date" class="font-semibold text-gray-700 block mb-2">é€‰æ‹©æŠ¥è¡¨æ—¥æœŸï¼š</label>
          <input type="date" id="report-date" class="input-field w-full" />
        </div>

        <!-- Welcome/Guidance Message -->
        <div id="daily-data-welcome-message" class="bg-blue-100 text-blue-800 p-3 rounded-lg mb-4 text-center font-semibold">
          æ¬¢è¿å›æ¥ï¼è¯·å½•å…¥ä»Šæ—¥æ•°æ®ï¼Œç„¶åç‚¹å‡»â€œä¿å­˜å¹¶è®¡ç®—â€ã€‚
        </div>
        
        <!-- Low Stock Warning Area -->
        <div id="low-stock-warning" class="hidden bg-yellow-100 border border-yellow-300 rounded text-yellow-800 font-semibold p-3 mb-4 transition-all duration-300 ease-in-out">
            <h4 class="font-bold mb-2 flex items-center justify-center">ğŸš¨ åº“å­˜é¢„è­¦ï¼šè¯·åŠæ—¶è¡¥è´§ï¼</h4>
            <ul id="low-stock-list" class="list-disc pl-5"></ul>
        </div>

        <div id="app" class="overflow-x-auto rounded-lg shadow-md mb-6"></div> <!-- Main input table -->
        <div class="flex flex-wrap justify-center gap-3 mb-6">
            <button onclick="saveAndCalculate()" class="btn-primary bg-blue-600 hover:bg-blue-700">âœ… ä¿å­˜å¹¶è®¡ç®—å½“æ—¥æ•°æ®</button>
            <button id="exportPdfButton" onclick="exportPDF()" class="btn-primary bg-green-600 hover:bg-green-700">ğŸ“„ å¯¼å‡ºå½“æ—¥æŠ¥è¡¨ (PDF)</button>
            <button onclick="restorePreviousState()" class="btn-primary bg-yellow-500 hover:bg-yellow-600">â†©ï¸ è¿˜åŸä¸ºä¸Šä¸€æ­¥</button>
            <button onclick="clearInputFields()" class="btn-primary bg-red-500 hover:bg-red-600">ğŸ§¹ æ¸…ç©ºè¾“å…¥</button>
        </div>
        <div id="result" class="mt-6 bg-blue-50 p-5 rounded-lg shadow-md border border-blue-200"></div>
      </div>

      <!-- Inventory Settings Page -->
      <div id="inventory-settings-page" class="page-content hidden">
        <div class="bg-gray-100 p-5 rounded-lg shadow-inner mb-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ“¦ è®¾ç½®åŸææ–™åº“å­˜</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4" id="stock-inputs-container">
            <!-- Material input fields will be dynamically generated by JS -->
          </div>
          <button onclick="saveInventory()" class="btn-primary bg-gray-600 hover:bg-gray-700 w-full">ğŸ’¾ ä¿å­˜åº“å­˜</button>
        </div>
      </div>

      <!-- Restock Page -->
      <div id="restock-page" class="page-content hidden">
        <div class="bg-gray-100 p-5 rounded-lg shadow-inner mb-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ›’ åŸææ–™è¿›è´§</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4" id="restock-inputs-container">
            <!-- Restock input fields will be dynamically generated by JS -->
          </div>
          <button onclick="confirmRestock()" class="btn-primary bg-orange-600 hover:bg-orange-700 w-full">âœ… ç¡®è®¤è¿›è´§</button>
        </div>
      </div>

      <!-- History & Charts Page -->
      <div id="history-charts-page" class="page-content hidden">
        <div id="summary" class="mt-0 bg-gray-50 p-5 rounded-lg shadow-md border border-gray-200">
          <h2 class="text-xl font-bold text-gray-700 mb-4">ğŸ“Š å†å²é”€å”®è®°å½•</h2>
          <!-- Historical records will be dynamically generated by JS -->
        </div>
        <div class="mt-6 p-5 bg-white rounded-lg shadow-md grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div>
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">å„å£å‘³ç´¯è®¡é”€é‡åˆ†å¸ƒ</h3>
            <canvas id="flavorPieChart" class="w-full max-w-xl mx-auto"></canvas>
            <p id="no-pie-data-message" class="text-center text-gray-500 mt-2 hidden">æš‚æ— é”€å”®è®°å½•ï¼Œæ— æ³•ç”Ÿæˆé¥¼çŠ¶å›¾ã€‚</p>
          </div>
          <div>
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">æ¯æ—¥æ€»é”€å”®é¢è¶‹åŠ¿</h3>
            <canvas id="salesTrendChart" class="w-full max-w-xl mx-auto"></canvas>
            <p id="no-trend-data-message" class="text-center text-gray-500 mt-2 hidden">æš‚æ— é”€å”®è®°å½•ï¼Œæ— æ³•ç”Ÿæˆè¶‹åŠ¿å›¾ã€‚</p>
          </div>
        </div>
      </div>

    </div> <!-- End pages-container -->

    <!-- Custom Message Box -->
    <div id="custom-message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
      <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center transform scale-95 transition-transform duration-300">
        <div id="message-icon" class="text-4xl mb-3"></div>
        <p id="custom-message-text" class="text-lg font-semibold mb-4"></p>
        <button onclick="hideMessageBox()" class="btn-primary bg-blue-600 hover:bg-blue-700 px-6 py-2">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <script>
    // Define flavors and materials
    const flavors = ['åŸå‘³', 'è‰è“å‘³', 'ç™¾é¦™æœå‘³', 'è”“è¶Šè“å‘³'];
    const materials = [
      { name: 'ç‰›å¥¶', unit: 'å‡', per50: 4, lowStockThreshold: 10 }, 
      { name: 'æ·¡å¥¶æ²¹', unit: 'åƒå…‹', per50: 1.8, lowStockThreshold: 5 },
      { name: 'ç‚¼ä¹³', unit: 'å…‹', per50: 50, lowStockThreshold: 200 },
      { name: 'å¥¶çš®ç²‰', unit: 'å…‹', per50: 500, lowStockThreshold: 1000 },
      { name: 'ç›Šç”ŸèŒç²‰', unit: 'å…‹', per50: 0.5, lowStockThreshold: 10 },
      { name: 'è‰è“å‘³æœå‘³ç²‰', unit: 'å…‹', per50: 181.5, lowStockThreshold: 500 },
      { name: 'ç™¾é¦™æœå‘³æœå‘³ç²‰', unit: 'å…‹', per50: 181.5, lowStockThreshold: 500 },
      { name: 'è”“è¶Šè“å‘³æœå‘³ç²‰', unit: 'å…‹', per50: 181.5, lowStockThreshold: 500 },
      { name: 'é…¸å¥¶ç›’', unit: 'ä¸ª', per50: 50, lowStockThreshold: 200 },
      { name: 'é…¸å¥¶ç›’ç›–', unit: 'ä¸ª', per50: 50, lowStockThreshold: 200 },
      { name: 'è¯•åƒæ¯', unit: 'ä¸ª', per50: 1, lowStockThreshold: 500 } 
    ];

    // Load inventory from LocalStorage, initialize as empty object if not found
    let inventory = JSON.parse(localStorage.getItem('inventory') || '{}');
    let pieChartInstance = null; 
    let salesTrendChartInstance = null;

    // --- Helper Functions ---

    // Display custom message box with type (success, warning, error)
    function showMessageBox(message, type = 'info') {
      const msgBox = document.getElementById('custom-message-box');
      const msgText = document.getElementById('custom-message-text');
      const msgIcon = document.getElementById('message-icon');

      msgText.innerText = message;
      msgIcon.innerHTML = ''; // Clear previous icon

      // Set icon and color based on message type
      if (type === 'success') {
        msgIcon.innerHTML = 'âœ…'; // Green checkmark
        msgIcon.style.color = '#10B981'; // Tailwind green-500
      } else if (type === 'warning') {
        msgIcon.innerHTML = 'âš ï¸'; // Yellow warning sign
        msgIcon.style.color = '#F59E0B'; // Tailwind yellow-500
      } else if (type === 'error') {
        msgIcon.innerHTML = 'âŒ'; // Red cross
        msgIcon.style.color = '#EF4444'; // Tailwind red-500
      } else { // Default info
        msgIcon.innerHTML = 'ğŸ’¡'; // Lightbulb
        msgIcon.style.color = '#3B82F6'; // Tailwind blue-500
      }
      
      msgBox.classList.remove('hidden');
      setTimeout(() => { // Subtle fade-in and scale-up effect
        msgBox.classList.remove('opacity-0');
        msgBox.querySelector('div').classList.remove('scale-95');
      }, 10);
    }

    // Hide custom message box
    function hideMessageBox() {
      const msgBox = document.getElementById('custom-message-box');
      msgBox.classList.add('opacity-0');
      msgBox.querySelector('div').classList.add('scale-95');
      setTimeout(() => { // Hide after animation
        msgBox.classList.add('hidden');
      }, 300);
    }

    // --- Page Navigation Function ---
    // Controls which content page is visible
    function showPage(pageId, clickedButton = null) {
      const allPageContents = document.querySelectorAll('.page-content');
      allPageContents.forEach(page => {
        page.classList.add('hidden'); // Hide all pages
      });

      const targetPage = document.getElementById(pageId);
      if (targetPage) {
        targetPage.classList.remove('hidden'); // Show target page

        // Update active tab styling
        document.querySelectorAll('.btn-tab').forEach(btn => {
          btn.classList.remove('active');
        });
        if (clickedButton) {
          clickedButton.classList.add('active');
        } else { // Handle initial load or direct function calls
            const defaultButton = document.querySelector(`.btn-tab[data-page-id="${pageId}"]`);
            if (defaultButton) defaultButton.classList.add('active');
        }

        // Specific actions for certain pages when they become visible
        if (pageId === 'inventory-settings-page') {
          renderStockPanelInputs(); 
        } else if (pageId === 'restock-page') {
          renderRestockPanelInputs(); 
        } else if (pageId === 'history-charts-page') {
          showRecentHistory(); 
          generatePieChart();
          generateSalesTrendChart();
        } else if (pageId === 'daily-data-page') {
          // Check for low stock on daily data page load
          checkLowStockAndDisplayWarning();
        }
      }
    }

    // --- Inventory Management Panel Functions ---

    // Renders input fields for setting raw material inventory
    function renderStockPanelInputs() {
      const container = document.getElementById("stock-inputs-container"); 
      container.innerHTML = materials.map(m => `
        <div>
          <label for="stock-${m.name}" class="block text-sm font-medium text-gray-700 mb-1">${m.name}ï¼ˆ${m.unit}ï¼‰</label>
          <input type="number" step="0.01" id="stock-${m.name}" class="input-field" value="${inventory[m.name] || 0}" />
          <label for="threshold-${m.name}" class="block text-xs font-medium text-gray-500 mt-1">æœ€ä½åº“å­˜ (${m.unit})</label>
          <input type="number" step="0.01" id="threshold-${m.name}" class="input-field text-xs" value="${m.lowStockThreshold || 0}" />
        </div>
      `).join('');
    }

    // Save raw material inventory and thresholds
    function saveInventory() {
      materials.forEach(m => {
        inventory[m.name] = parseFloat(document.getElementById("stock-" + m.name).value) || 0;
        const thresholdInput = document.getElementById(`threshold-${m.name}`);
        if(thresholdInput) {
            m.lowStockThreshold = parseFloat(thresholdInput.value) || 0;
        }
      });
      localStorage.setItem("inventory", JSON.stringify(inventory));
      showMessageBox("åŸææ–™åº“å­˜åŠé¢„è­¦é˜ˆå€¼å·²æ›´æ–°ï¼", 'success');
      showPage('daily-data-page'); // Return to daily data page after saving
    }

    // --- Raw Material Restock Functions ---

    // Renders input fields for raw material restock
    function renderRestockPanelInputs() {
      const container = document.getElementById("restock-inputs-container"); 
      container.innerHTML = materials.map(m => `
        <div>
          <label for="restock-${m.name}" class="block text-sm font-medium text-gray-700 mb-1">${m.name}ï¼ˆ${m.unit}ï¼‰</label>
          <input type="number" step="0.01" id="restock-${m.name}" class="input-field" value="0" placeholder="è¯·è¾“å…¥è¿›è´§é‡" />
        </div>
      `).join('');
    }

    // Confirm raw material restock
    function confirmRestock() {
      let restockSuccessful = true;
      materials.forEach(m => {
        const restockAmount = parseFloat(document.getElementById("restock-" + m.name).value) || 0;
        if (isNaN(restockAmount) || restockAmount < 0) {
            showMessageBox(`è¯·è¾“å…¥æœ‰æ•ˆçš„ ${m.name} è¿›è´§é‡ï¼ˆéè´Ÿæ•°å­—ï¼‰ï¼`, 'warning');
            restockSuccessful = false;
            return; 
        }
        inventory[m.name] = (inventory[m.name] || 0) + restockAmount; 
      });

      if (restockSuccessful) {
        localStorage.setItem("inventory", JSON.stringify(inventory)); 
        showMessageBox("åŸææ–™è¿›è´§å·²å®Œæˆï¼", 'success');
        showPage('daily-data-page'); // Return to daily data page after restocking
      }
    }

    // --- Current Day Input Persistence ---
    function saveCurrentInputs() {
        const currentInputs = {};
        flavors.forEach(f => {
            currentInputs[`${f}-start-10am`] = document.getElementById(`${f}-start-10am`).value;
            currentInputs[`${f}-end-8pm`] = document.getElementById(`${f}-end-8pm`).value;
            currentInputs[`${f}-yesterday-made-today-available`] = document.getElementById(`${f}-yesterday-made-today-available`).value;
            currentInputs[`${f}-theoretical-production-for-raw-materials`] = document.getElementById(`${f}-theoretical-production-for-raw-materials`).value;
            currentInputs[`${f}-taste-cups`] = document.getElementById(`${f}-taste-cups`).value;
        });
        currentInputs['note'] = document.getElementById('note').value;
        currentInputs['currentDate'] = document.getElementById('report-date').value; 
        localStorage.setItem('currentDayInputs', JSON.stringify(currentInputs));
    }

    function loadCurrentInputs() {
        const savedInputs = JSON.parse(localStorage.getItem('currentDayInputs') || '{}');
        flavors.forEach(f => {
            if (savedInputs[`${f}-start-10am`]) document.getElementById(`${f}-start-10am`).value = savedInputs[`${f}-start-10am`];
            if (savedInputs[`${f}-end-8pm`]) document.getElementById(`${f}-end-8pm`).value = savedInputs[`${f}-end-8pm`];
            if (savedInputs[`${f}-yesterday-made-today-available`]) document.getElementById(`${f}-yesterday-made-today-available`).value = savedInputs[`${f}-yesterday-made-today-available`];
            if (savedInputs[`${f}-theoretical-production-for-raw-materials`]) document.getElementById(`${f}-theoretical-production-for-raw-materials`).value = savedInputs[`${f}-theoretical-production-for-raw-materials`];
            if (savedInputs[`${f}-taste-cups`]) document.getElementById(`${f}-taste-cups`).value = savedInputs[`${f}-taste-cups`];
        });
        if (savedInputs['note']) document.getElementById('note').value = savedInputs['note'];
        
        const dateInput = document.getElementById('report-date');
        if (savedInputs['currentDate']) {
            dateInput.value = savedInputs['currentDate'];
        } else {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
        }

        document.querySelectorAll('.input-field').forEach(input => {
            input.addEventListener('input', saveCurrentInputs);
        });
        document.getElementById('note').addEventListener('input', saveCurrentInputs);
        document.getElementById('report-date').addEventListener('change', saveCurrentInputs); 
    }

    // --- Main Interface Rendering Function ---

    // Render the main data input table
    function renderTable() {
      const app = document.getElementById("app");
      let html = `
      <table class="w-full table-auto text-sm border-collapse rounded-lg overflow-hidden">
        <thead class="bg-blue-100 text-blue-800">
          <tr>
            <th class="table-header">å£å‘³</th>
            <th class="table-header">ä»Šæ—¥10ç‚¹åº“å­˜ (æ¯)</th>
            <th class="table-header">ä»Šæ—¥20ç‚¹åº“å­˜ (æ¯)</th>
            <th class="table-header">æ˜¨æ—¥æ–°åš<br/>(ä»Šæ—¥å¯å”®) (æ¯)</th>
            <th class="table-header">ä»Šæ—¥ç†è®ºåˆ¶ä½œ<br/>(åŸææ–™è®¡ç®—ç”¨) (æ¯)</th>
            <th class="table-header">ä»Šæ—¥è¯•åƒæ¶ˆè€— (è¯•åƒæ¯)</th>
          </tr>
        </thead>
        <tbody>
          ${flavors.map(f => `
            <tr class="hover:bg-gray-50">
              <td class="table-data font-semibold text-gray-700">${f}</td>
              <td class="table-data"><input type="number" step="0.1" class="input-field" id="${f}-start-10am" value="0" placeholder="ä¾‹å¦‚: 50.0" /></td>
              <td class="table-data"><input type="number" step="0.1" class="input-field" id="${f}-end-8pm" value="0" placeholder="ä¾‹å¦‚: 30.0" /></td>
              <td class="table-data"><input type="number" step="0.1" class="input-field" id="${f}-yesterday-made-today-available" value="0" placeholder="ä¾‹å¦‚: 20.0" /></td>
              <td class="table-data"><input type="number" step="0.1" class="input-field" id="${f}-theoretical-production-for-raw-materials" value="0" placeholder="ä¾‹å¦‚: 60.0" /></td>
              <td class="table-data"><input type="number" step="1" class="input-field" id="${f}-taste-cups" value="0" placeholder="ä¾‹å¦‚: 100" /></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      <div class="mt-4 p-4 bg-gray-100 rounded-lg">
        <label for="note" class="font-semibold text-gray-700 block mb-2">å¤‡æ³¨ï¼š</label>
        <input id="note" class="input-field w-full" placeholder="å¦‚ï¼šä¸‹é›¨å¤©ã€èŠ‚å‡æ—¥ã€ä¿ƒé”€ç­‰" />
      </div>`;
      app.innerHTML = html;
      loadCurrentInputs(); // Load previously saved inputs
    }

    // --- Main Calculation Logic ---

    // Save and calculate daily data
    function saveAndCalculate() {
      // Backup current state for restore
      localStorage.setItem("previousInventory", localStorage.getItem("inventory"));
      localStorage.setItem("previousSaleHistory", localStorage.getItem("saleHistory"));

      let totalCustomerSales = 0; 
      let totalIncome = 0;        
      let totalTheoreticalProductionForRawMaterials = 0; 

      const flavorStats = {};
      const matUse = {};
      materials.forEach(m => matUse[m.name] = 0); 

      let inputError = false; 
      flavors.forEach(f => {
        const start_stock_10am = parseFloat(document.getElementById(`${f}-start-10am`).value);
        const end_stock_8pm = parseFloat(document.getElementById(`${f}-end-8pm`).value);
        const yesterday_made_today_available = parseFloat(document.getElementById(`${f}-yesterday-made-today-available`).value); 
        const theoretical_production_for_raw_materials = parseFloat(document.getElementById(`${f}-theoretical-production-for-raw-materials`).value); 
        const taste_test_cups_used = parseFloat(document.getElementById(`${f}-taste-cups`).value);     

        if (isNaN(start_stock_10am) || isNaN(end_stock_8pm) || isNaN(yesterday_made_today_available) || isNaN(theoretical_production_for_raw_materials) || isNaN(taste_test_cups_used)) {
            inputError = true;
            return; 
        }

        const taste_test_equivalent_normal_cups = taste_test_cups_used / 50;
        const daily_customer_sales = (start_stock_10am + yesterday_made_today_available - end_stock_8pm) - taste_test_equivalent_normal_cups;
        const final_sales = Math.max(0, daily_customer_sales); 

        const price = f === 'åŸå‘³' ? 8 : 9.9;
        const income = final_sales * price;

        totalCustomerSales += final_sales;
        totalIncome += income;

        flavorStats[f] = {
            å”®å‡ºæ¯æ•°: final_sales,
            å•ä»·: price.toFixed(2),
            é”€å”®é¢: income.toFixed(2),
            ä»Šæ—¥ç†è®ºåˆ¶ä½œ: theoretical_production_for_raw_materials,
            è¯•åƒæ¯æ•°: taste_test_cups_used 
        };

        if (f === 'è‰è“å‘³') matUse['è‰è“å‘³æœå‘³ç²‰'] += theoretical_production_for_raw_materials * 181.5 / 50;
        if (f === 'ç™¾é¦™æœå‘³') matUse['ç™¾é¦™æœå‘³æœå‘³ç²‰'] += theoretical_production_for_raw_materials * 181.5 / 50;
        if (f === 'è”“è¶Šè“å‘³') matUse['è”“è¶Šè“å‘³æœå‘³ç²‰'] += theoretical_production_for_raw_materials * 181.5 / 50;
        
        matUse['é…¸å¥¶ç›’'] += theoretical_production_for_raw_materials; 
        matUse['é…¸å¥¶ç›’ç›–'] += theoretical_production_for_raw_materials; 

        matUse['è¯•åƒæ¯'] += taste_test_cups_used; 

        totalTheoreticalProductionForRawMaterials += theoretical_production_for_raw_materials;
      });

      if (inputError) {
          showMessageBox("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ï¼", 'error');
          return; 
      }

      matUse['ç‰›å¥¶'] += totalTheoreticalProductionForRawMaterials * materials.find(m => m.name === 'ç‰›å¥¶').per50 / 50;
      matUse['æ·¡å¥¶æ²¹'] += totalTheoreticalProductionForRawMaterials * materials.find(m => m.name === 'æ·¡å¥¶æ²¹').per50 / 50;
      matUse['ç‚¼ä¹³'] += totalTheoreticalProductionForRawMaterials * materials.find(m => m.name === 'ç‚¼ä¹³').per50 / 50;
      matUse['å¥¶çš®ç²‰'] += totalTheoreticalProductionForRawMaterials * materials.find(m => m.name === 'å¥¶çš®ç²‰').per50 / 50;
      matUse['ç›Šç”ŸèŒç²‰'] += totalTheoreticalProductionForRawMaterials * materials.find(m => m.name === 'ç›Šç”ŸèŒç²‰').per50 / 50;


      let resultHtml = `<h2 class='text-xl font-bold text-blue-700 mb-4'>ğŸ“Š ä»Šæ—¥é”€å”®æ±‡æ€»ä¸åŸææ–™æ¶ˆè€—</h2>`;
      resultHtml += `<div class="bg-white p-4 rounded-lg shadow-inner mb-4">
                        <h3 class='text-lg font-semibold text-blue-600 mb-2'>é”€å”®æƒ…å†µ</h3>
                        <ul class='list-disc pl-6 text-gray-800'>`;
      for (const f in flavorStats) {
        resultHtml += `<li>${f}ï¼šå”®å‡º <span class="font-bold text-lg">${flavorStats[f].å”®å‡ºæ¯æ•°.toFixed(1)}</span> æ¯ï¼Œå•ä»· ${flavorStats[f].å•ä»·} å…ƒï¼Œè¥ä¸šé¢ <span class="font-bold text-lg">${flavorStats[f].é”€å”®é¢}</span> å…ƒ</li>`;
        resultHtml += `<li class="ml-4 text-gray-600">ä»Šæ—¥ç†è®ºåˆ¶ä½œï¼š${flavorStats[f].ä»Šæ—¥ç†è®ºåˆ¶ä½œ} æ¯ï¼Œè¯•åƒï¼š${flavorStats[f].è¯•åƒæ¯æ•°} è¯•åƒæ¯</li>`;
      }
      resultHtml += `</ul><p class='mt-4 font-extrabold text-blue-800 text-xl'>æ€»å”®å‡ºï¼š${totalCustomerSales.toFixed(1)} æ¯ï¼Œæ€»æ”¶å…¥ï¼š${totalIncome.toFixed(2)} å…ƒ</p></div>`;

      resultHtml += `<div class="bg-white p-4 rounded-lg shadow-inner">
                        <h3 class='text-lg font-semibold text-blue-600 mb-2'>åŸææ–™æ¶ˆè€—åŠåº“å­˜å˜åŒ–</h3>
                        <ul class='list-disc pl-6 text-gray-800'>`;
      const consumptionToday = [];
      let lowStockAlerts = []; 

      materials.forEach(m => {
        const used = matUse[m.name];
        const remain = (inventory[m.name] || 0) - used; 
        const warnClass = remain < 0 ? 'text-red-600 font-bold' : 'text-green-700'; 
        resultHtml += `<li>${m.name}ï¼šæ¶ˆè€— <span class="font-bold">${used.toFixed(2)}</span> ${m.unit}, 
                        <span class="${warnClass}">å‰©ä½™ ${remain.toFixed(2)} ${m.unit}</span></li>`;
        inventory[m.name] = remain; 

        consumptionToday.push({ åŸææ–™: m.name, å•ä½: m.unit, æ¶ˆè€—é‡: used.toFixed(2), å‰©ä½™åº“å­˜: remain.toFixed(2) });
      });
      resultHtml += `</ul></div>`;

      document.getElementById("result").innerHTML = resultHtml;

      localStorage.setItem("inventory", JSON.stringify(inventory)); 

      const date = document.getElementById('report-date').value; 
      const note = document.getElementById("note").value || "æ— "; 

      const history = JSON.parse(localStorage.getItem("saleHistory") || "[]");
      history.push({ 
        æ—¥æœŸ: date, 
        å”®å‡ºæ€»é‡: totalCustomerSales.toFixed(1), 
        æ€»è¥ä¸šé¢: totalIncome.toFixed(2), 
        å¤‡æ³¨: note, 
        æ˜ç»†: flavorStats,
        åŸææ–™æ¶ˆè€—: consumptionToday
      });
      localStorage.setItem("saleHistory", JSON.stringify(history)); 

      showMessageBox("è®¡ç®—å®Œæˆï¼Œæ•°æ®å·²ä¿å­˜ï¼", 'success');
      
      // Update low stock warning on daily data page
      checkLowStockAndDisplayWarning(); 
      // Clear inputs after successful calculation and saving
      clearInputFields(false); // Do not show "è¾“å…¥å·²æ¸…ç©º" message
    }

    // --- Check Low Stock and Display Warning ---
    function checkLowStockAndDisplayWarning() {
        const lowStockList = document.getElementById('low-stock-list');
        const lowStockWarningDiv = document.getElementById('low-stock-warning');
        let alertsHtml = '';
        let hasLowStock = false;

        materials.forEach(m => {
            const currentStock = inventory[m.name] || 0;
            if (currentStock < m.lowStockThreshold) {
                alertsHtml += `<li>${m.name}ï¼šç›®å‰å‰©ä½™ ${currentStock.toFixed(2)} ${m.unit}ï¼Œä½äºé¢„è­¦å€¼ ${m.lowStockThreshold} ${m.unit}ã€‚</li>`;
                hasLowStock = true;
            }
        });

        if (hasLowStock) {
            lowStockList.innerHTML = alertsHtml;
            lowStockWarningDiv.classList.remove('hidden');
        } else {
            lowStockWarningDiv.classList.add('hidden');
            lowStockList.innerHTML = '';
        }
    }


    // --- Historical Record Display Function ---

    // Display recent sales history
    function showRecentHistory() {
      const history = JSON.parse(localStorage.getItem("saleHistory") || "[]");
      const summaryDiv = document.getElementById("summary");
      if (!history.length) {
        summaryDiv.innerHTML = "<p class='text-center text-gray-500'>æš‚æ— é”€å”®è®°å½•</p>";
        return;
      }

      let html = `<h2 class="text-xl font-bold text-gray-700 mb-4">ğŸ“Š å†å²é”€å”®è®°å½•</h2>`;
      html += `<div class="overflow-x-auto rounded-lg shadow-md border border-gray-300">
                <table class="w-full table-auto text-sm border-collapse">
                  <thead class="bg-gray-200 text-gray-700">
                    <tr>
                      <th class="table-header">æ—¥æœŸ</th>
                      <th class="table-header">å£å‘³</th>
                      <th class="table-header">å”®å‡ºæ¯æ•°</th>
                      <th class="table-header">å•ä»·</th>
                      <th class="table-header">é”€å”®é¢</th>
                      <th class="table-header">ä»Šæ—¥ç†è®ºåˆ¶ä½œ</th>
                      <th class="table-header">è¯•åƒæ¯æ•°</th>
                      <th class="table-header">å¤‡æ³¨</th>
                    </tr>
                  </thead>
                  <tbody>`;
      history.slice().reverse().forEach(r => {
        let firstRow = true;
        for (const f of flavors) {
          if (r.æ˜ç»† && r.æ˜ç»†[f]) {
            html += `<tr class="border-t border-gray-200 hover:bg-gray-50">
              <td class='table-data ${firstRow ? 'font-semibold' : ''}'>${firstRow ? r.æ—¥æœŸ : ''}</td>
              <td class='table-data'>${f}</td>
              <td class='table-data'>${r.æ˜ç»†[f].å”®å‡ºæ¯æ•°.toFixed(1)}</td>
              <td class='table-data'>${r.æ˜ç»†[f].å•ä»·}</td>
              <td class='table-data'>${r.æ˜ç»†[f].é”€å”®é¢}</td>
              <td class='table-data'>${r.æ˜ç»†[f].ä»Šæ—¥ç†è®ºåˆ¶ä½œ || '0'}</td>
              <td class='table-data'>${r.æ˜ç»†[f].è¯•åƒæ¯æ•° || '0'}</td>
              <td class='table-data ${firstRow ? 'font-semibold' : ''}'>${firstRow ? (r.å¤‡æ³¨ || 'æ— ') : ''}</td>
            </tr>`;
            firstRow = false;
          }
        }
        html += `<tr class="bg-gray-100 font-bold">
                    <td class="table-data" colspan="2">æ€»è®¡</td>
                    <td class="table-data">${r.å”®å‡ºæ€»é‡}</td>
                    <td class="table-data"></td>
                    <td class="table-data">${r.æ€»è¥ä¸šé¢}</td>
                    <td class="table-data" colspan="3"></td>
                  </tr>`;
      });
      html += `</tbody></table></div>`;
      summaryDiv.innerHTML = html;
    }


    // --- Chart Generation Functions ---

    function generatePieChart() {
      const history = JSON.parse(localStorage.getItem("saleHistory") || "[]");
      const noDataMessage = document.getElementById('no-pie-data-message');
      const ctx = document.getElementById("flavorPieChart").getContext("2d");

      if (!history.length) {
        if (pieChartInstance) pieChartInstance.destroy(); 
        noDataMessage.classList.remove('hidden'); // Show no data message
        return;
      }
      noDataMessage.classList.add('hidden'); // Hide no data message

      const salesByFlavor = {};
      flavors.forEach(f => salesByFlavor[f] = 0); 

      history.forEach(r => {
        for (let f in r.æ˜ç»†) {
          salesByFlavor[f] += Number(r.æ˜ç»†[f].å”®å‡ºæ¯æ•° || 0);
        }
      });

      if (pieChartInstance) {
        pieChartInstance.destroy();
      }

      pieChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: flavors, 
          datasets: [{
            data: flavors.map(f => salesByFlavor[f]), 
            backgroundColor: [
              '#f87171', '#facc15', '#34d399', '#60a5fa' 
            ],
            borderColor: '#fff', 
            borderWidth: 2, 
          }]
        },
        options: {
          responsive: true, 
          maintainAspectRatio: true, 
          plugins: {
            legend: {
              position: 'top', 
              labels: {
                font: { size: 14 }
              }
            },
            title: {
              display: true,
              text: 'å„å£å‘³ç´¯è®¡é”€é‡åˆ†å¸ƒ', 
              font: { size: 18, weight: 'bold' },
              color: '#374151' 
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  if (label) label += ': ';
                  if (context.parsed !== null) label += context.parsed.toFixed(1) + ' æ¯'; 
                  return label;
                }
              }
            }
          }
        }
      });
    }

    function generateSalesTrendChart() {
        const history = JSON.parse(localStorage.getItem("saleHistory") || "[]");
        const noDataMessage = document.getElementById('no-trend-data-message');
        const ctx = document.getElementById("salesTrendChart").getContext("2d");

        if (!history.length) {
            if (salesTrendChartInstance) salesTrendChartInstance.destroy();
            noDataMessage.classList.remove('hidden'); // Show no data message
            return;
        }
        noDataMessage.classList.add('hidden'); // Hide no data message

        const dailySales = {};
        history.forEach(r => {
            const date = r.æ—¥æœŸ;
            const totalSales = parseFloat(r.æ€»è¥ä¸šé¢ || 0);
            dailySales[date] = (dailySales[date] || 0) + totalSales;
        });

        const sortedDates = Object.keys(dailySales).sort();
        const salesData = sortedDates.map(date => dailySales[date]);

        if (salesTrendChartInstance) {
            salesTrendChartInstance.destroy();
        }

        salesTrendChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedDates,
                datasets: [{
                    label: 'æ¯æ—¥æ€»é”€å”®é¢ (å…ƒ)',
                    data: salesData,
                    borderColor: '#4299e1', 
                    backgroundColor: 'rgba(66, 153, 225, 0.2)', 
                    fill: true,
                    tension: 0.3, 
                    pointBackgroundColor: '#4299e1',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#4299e1',
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false 
                    },
                    title: {
                        display: true,
                        text: 'æ¯æ—¥æ€»é”€å”®é¢è¶‹åŠ¿',
                        font: { size: 18, weight: 'bold' },
                        color: '#374151'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) label += `${context.parsed.y.toFixed(2)} å…ƒ`;
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'æ—¥æœŸ'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'é”€å”®é¢ (å…ƒ)'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }


    // --- PDF Export Function ---

    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4'); 
      
      const exportButton = document.getElementById('exportPdfButton');
      exportButton.disabled = true;
      exportButton.textContent = 'ğŸ“„ å¯¼å‡ºä¸­...';

      const target = document.getElementById('daily-data-page'); 

      const allPageContents = document.querySelectorAll('.page-content');
      allPageContents.forEach(page => {
          if (page.id !== 'daily-data-page') { 
              page.classList.add('hidden'); 
          }
      });
      const globalNavButtons = document.querySelectorAll('.flex.flex-wrap.justify-center.gap-3.mb-6 button'); 
      globalNavButtons.forEach(btn => btn.classList.add('hidden'));

      // Temporarily hide elements not needed in the export, e.g., welcome message, low stock warning
      document.getElementById('daily-data-welcome-message').classList.add('hidden');
      document.getElementById('low-stock-warning').classList.add('hidden');


      try {
        await html2canvas(target, { 
          scale: 2, 
          useCORS: true, 
          logging: false 
        }).then(canvas => {
          const imgData = canvas.toDataURL('image/png'); 
          const imgProps = pdf.getImageProperties(imgData);
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width; 

          pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        });

        pdf.save('é…¸å¥¶ç®¡ç†ç³»ç»Ÿ_æ—¥æŠ¥_' + document.getElementById('report-date').value + '.pdf'); 
        showMessageBox("æ—¥æŠ¥å·²å¯¼å‡ºä¸ºPDFï¼", 'success');
      } catch (error) {
        console.error("PDF Export failed:", error);
        showMessageBox("PDF å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•ï¼", 'error');
      } finally {
        allPageContents.forEach(page => {
            if (page.id !== 'daily-data-page') {
                page.classList.add('hidden'); 
            } else {
                page.classList.remove('hidden'); 
            }
        });
        globalNavButtons.forEach(btn => btn.classList.remove('hidden')); 
        
        // Restore welcome message and low stock warning visibility based on state
        document.getElementById('daily-data-welcome-message').classList.remove('hidden');
        checkLowStockAndDisplayWarning(); // Re-evaluate and show if needed

        exportButton.disabled = false;
        exportButton.textContent = 'ğŸ“„ å¯¼å‡ºå½“æ—¥æŠ¥è¡¨ (PDF)';
      }
    }

    // --- State Restore Function ---

    // Restore to previous operation state
    function restorePreviousState() {
      const previousInventory = localStorage.getItem("previousInventory");
      const previousHistory = localStorage.getItem("previousSaleHistory");

      if (!previousInventory && !previousHistory) {
        showMessageBox("æ²¡æœ‰å¯è¿˜åŸçš„æ•°æ®ã€‚", 'info');
        return;
      }

      document.getElementById('custom-message-text').innerText = "ç¡®å®šè¦è¿˜åŸä¸ºä¸Šä¸€æ­¥å—ï¼Ÿè¿™å°†æ’¤é”€å½“å‰æ›´æ”¹å¹¶é‡æ–°åŠ è½½é¡µé¢ã€‚";
      document.getElementById('message-icon').innerHTML = 'â†©ï¸';
      document.getElementById('message-icon').style.color = '#F59E0B'; // Yellowish for warning
      document.getElementById('custom-message-box').classList.remove('hidden');
      setTimeout(() => { 
        document.getElementById('custom-message-box').classList.remove('opacity-0');
        document.getElementById('custom-message-box').querySelector('div').classList.remove('scale-95');
      }, 10);
      
      const confirmButton = document.querySelector('#custom-message-box button');
      confirmButton.onclick = null; 
      confirmButton.onclick = () => {
        if (previousInventory) {
          localStorage.setItem("inventory", previousInventory);
        } else {
          localStorage.removeItem("inventory"); 
        }
        if (previousHistory) {
          localStorage.setItem("saleHistory", previousHistory);
        } else {
          localStorage.removeItem("saleHistory"); 
        }
        localStorage.removeItem('currentDayInputs'); 
        location.reload(); 
      };
    }
    
    // --- Clear Input Fields Function ---
    function clearInputFields(showMessage = true) {
        flavors.forEach(f => {
            document.getElementById(`${f}-start-10am`).value = 0;
            document.getElementById(`${f}-end-8pm`).value = 0;
            document.getElementById(`${f}-yesterday-made-today-available`).value = 0;
            document.getElementById(`${f}-theoretical-production-for-raw-materials`).value = 0;
            document.getElementById(`${f}-taste-cups`).value = 0;
        });
        document.getElementById("note").value = "";
        localStorage.removeItem('currentDayInputs'); 
        if (showMessage) {
          showMessageBox("è¾“å…¥å·²æ¸…ç©ºï¼", 'info');
        }
    }


    // --- Execute on Page Load ---
    window.onload = () => {
      renderTable(); 
      showPage('daily-data-page'); 
    };
  </script>

  <style>
    /* Tailwind CSS base styles */
    body {
      font-family: 'Inter', sans-serif;
    }
    .btn-primary {
      @apply px-5 py-2 rounded-lg font-bold text-white transition duration-200 ease-in-out transform hover:scale-105 shadow-md;
    }
    .input-field {
      @apply w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out;
    }
    .table-header {
      @apply px-2 py-3 border-b-2 border-blue-200 text-left text-xs font-semibold uppercase tracking-wider;
    }
    .table-data {
      @apply px-2 py-2 border-b border-gray-200 text-gray-900;
    }
    .page-content {
      @apply p-4 border border-gray-200 rounded-lg bg-white;
    }
    .btn-tab {
        @apply px-4 py-2 rounded-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-200 ease-in-out;
    }
    .btn-tab.active {
        @apply bg-blue-600 text-white shadow-md;
    }
  </style>
</body>
</html>
