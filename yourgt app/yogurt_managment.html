<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>酸奶库存与销售管理系统 v5.7</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Phosphor Icons for better UX. Add this if needed. -->
  <!-- <script src="https://unpkg.com/@phosphor-icons/web@2.0.3/dist/phosphor.js"></script> -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  ```html <script> 
  // Register Service Worker if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js') .then(registration => { console.log('ServiceWorker registration successful with scope: ', registration.scope); }) .catch(err => { console.log('ServiceWorker registration failed: ', err); }); }); } 
  </script>
</head>
<body class="bg-gray-50 text-gray-900 p-4 font-sans antialiased">
  <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-lg p-6">
    <h1 class="text-3xl font-extrabold text-center text-blue-800 mb-6">酸奶库存与销售管理系统 v5.7
      
    </h1>

    <!-- Top Navigation Buttons -->
    <div class="flex flex-wrap justify-center gap-3 mb-6 border-b pb-4 border-gray-200">
      <button onclick="showPage('daily-data-page', this)" class="btn-tab active" data-page-id="daily-data-page">📝 每日数据</button>
      <button onclick="showPage('inventory-settings-page', this)" class="btn-tab" data-page-id="inventory-settings-page">🛠️ 库存设置</button>
      <button onclick="showPage('restock-page', this)" class="btn-tab" data-page-id="restock-page">🛒 原材料进货</button>
      <button onclick="showPage('history-charts-page', this)" class="btn-tab" data-page-id="history-charts-page">📈 历史与图表</button>
    </div>

    <!-- Pages Container -->
    <div id="pages-container">

      <!-- Daily Data Page -->
      <div id="daily-data-page" class="page-content">
        <div class="mb-4 p-4 bg-gray-100 rounded-lg">
          <label for="report-date" class="font-semibold text-gray-700 block mb-2">选择报表日期：</label>
          <input type="date" id="report-date" class="input-field w-full" />
        </div>

        <!-- Welcome/Guidance Message -->
        <div id="daily-data-welcome-message" class="bg-blue-100 text-blue-800 p-3 rounded-lg mb-4 text-center font-semibold">
          欢迎回来！请录入今日数据，然后点击“保存并计算”。
        </div>
        
        <!-- Low Stock Warning Area -->
        <div id="low-stock-warning" class="hidden bg-yellow-100 border border-yellow-300 rounded text-yellow-800 font-semibold p-3 mb-4 transition-all duration-300 ease-in-out">
            <h4 class="font-bold mb-2 flex items-center justify-center">🚨 库存预警：请及时补货！</h4>
            <ul id="low-stock-list" class="list-disc pl-5"></ul>
        </div>

        <div id="app" class="overflow-x-auto rounded-lg shadow-md mb-6"></div> <!-- Main input table -->
        <div class="flex flex-wrap justify-center gap-3 mb-6">
            <button onclick="saveAndCalculate()" class="btn-primary bg-blue-600 hover:bg-blue-700">✅ 保存并计算当日数据</button>
            <button id="exportPdfButton" onclick="exportPDF()" class="btn-primary bg-green-600 hover:bg-green-700">📄 导出当日报表 (PDF)</button>
            <button onclick="restorePreviousState()" class="btn-primary bg-yellow-500 hover:bg-yellow-600">↩️ 还原为上一步</button>
            <button onclick="clearInputFields()" class="btn-primary bg-red-500 hover:bg-red-600">🧹 清空输入</button>
        </div>
        <div id="result" class="mt-6 bg-blue-50 p-5 rounded-lg shadow-md border border-blue-200"></div>
      </div>

      <!-- Inventory Settings Page -->
      <div id="inventory-settings-page" class="page-content hidden">
        <div class="bg-gray-100 p-5 rounded-lg shadow-inner mb-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">📦 设置原材料库存</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4" id="stock-inputs-container">
            <!-- Material input fields will be dynamically generated by JS -->
          </div>
          <button onclick="saveInventory()" class="btn-primary bg-gray-600 hover:bg-gray-700 w-full">💾 保存库存</button>
        </div>
      </div>

      <!-- Restock Page -->
      <div id="restock-page" class="page-content hidden">
        <div class="bg-gray-100 p-5 rounded-lg shadow-inner mb-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">🛒 原材料进货</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4" id="restock-inputs-container">
            <!-- Restock input fields will be dynamically generated by JS -->
          </div>
          <button onclick="confirmRestock()" class="btn-primary bg-orange-600 hover:bg-orange-700 w-full">✅ 确认进货</button>
        </div>
      </div>

      <!-- History & Charts Page -->
      <div id="history-charts-page" class="page-content hidden">
        <div id="summary" class="mt-0 bg-gray-50 p-5 rounded-lg shadow-md border border-gray-200">
          <h2 class="text-xl font-bold text-gray-700 mb-4">📊 历史销售记录</h2>
          <!-- Historical records will be dynamically generated by JS -->
        </div>
        <div class="mt-6 p-5 bg-white rounded-lg shadow-md grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div>
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">各口味累计销量分布</h3>
            <canvas id="flavorPieChart" class="w-full max-w-xl mx-auto"></canvas>
            <p id="no-pie-data-message" class="text-center text-gray-500 mt-2 hidden">暂无销售记录，无法生成饼状图。</p>
          </div>
          <div>
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">每日总销售额趋势</h3>
            <canvas id="salesTrendChart" class="w-full max-w-xl mx-auto"></canvas>
            <p id="no-trend-data-message" class="text-center text-gray-500 mt-2 hidden">暂无销售记录，无法生成趋势图。</p>
          </div>
        </div>
      </div>

    </div> <!-- End pages-container -->

    <!-- Custom Message Box -->
    <div id="custom-message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
      <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center transform scale-95 transition-transform duration-300">
        <div id="message-icon" class="text-4xl mb-3"></div>
        <p id="custom-message-text" class="text-lg font-semibold mb-4"></p>
        <button onclick="hideMessageBox()" class="btn-primary bg-blue-600 hover:bg-blue-700 px-6 py-2">确定</button>
      </div>
    </div>
  </div>

  <script>
    // Define flavors and materials
    const flavors = ['原味', '草莓味', '百香果味', '蔓越莓味'];
    const materials = [
      { name: '牛奶', unit: '升', per50: 4, lowStockThreshold: 10 }, 
      { name: '淡奶油', unit: '千克', per50: 1.8, lowStockThreshold: 5 },
      { name: '炼乳', unit: '克', per50: 50, lowStockThreshold: 200 },
      { name: '奶皮粉', unit: '克', per50: 500, lowStockThreshold: 1000 },
      { name: '益生菌粉', unit: '克', per50: 0.5, lowStockThreshold: 10 },
      { name: '草莓味果味粉', unit: '克', per50: 181.5, lowStockThreshold: 500 },
      { name: '百香果味果味粉', unit: '克', per50: 181.5, lowStockThreshold: 500 },
      { name: '蔓越莓味果味粉', unit: '克', per50: 181.5, lowStockThreshold: 500 },
      { name: '酸奶盒', unit: '个', per50: 50, lowStockThreshold: 200 },
      { name: '酸奶盒盖', unit: '个', per50: 50, lowStockThreshold: 200 },
      { name: '试吃杯', unit: '个', per50: 1, lowStockThreshold: 500 } 
    ];

    // Load inventory from LocalStorage, initialize as empty object if not found
    let inventory = JSON.parse(localStorage.getItem('inventory') || '{}');
    let pieChartInstance = null; 
    let salesTrendChartInstance = null;

    // --- Helper Functions ---

    // Display custom message box with type (success, warning, error)
    function showMessageBox(message, type = 'info') {
      const msgBox = document.getElementById('custom-message-box');
      const msgText = document.getElementById('custom-message-text');
      const msgIcon = document.getElementById('message-icon');

      msgText.innerText = message;
      msgIcon.innerHTML = ''; // Clear previous icon

      // Set icon and color based on message type
      if (type === 'success') {
        msgIcon.innerHTML = '✅'; // Green checkmark
        msgIcon.style.color = '#10B981'; // Tailwind green-500
      } else if (type === 'warning') {
        msgIcon.innerHTML = '⚠️'; // Yellow warning sign
        msgIcon.style.color = '#F59E0B'; // Tailwind yellow-500
      } else if (type === 'error') {
        msgIcon.innerHTML = '❌'; // Red cross
        msgIcon.style.color = '#EF4444'; // Tailwind red-500
      } else { // Default info
        msgIcon.innerHTML = '💡'; // Lightbulb
        msgIcon.style.color = '#3B82F6'; // Tailwind blue-500
      }
      
      msgBox.classList.remove('hidden');
      setTimeout(() => { // Subtle fade-in and scale-up effect
        msgBox.classList.remove('opacity-0');
        msgBox.querySelector('div').classList.remove('scale-95');
      }, 10);
    }

    // Hide custom message box
    function hideMessageBox() {
      const msgBox = document.getElementById('custom-message-box');
      msgBox.classList.add('opacity-0');
      msgBox.querySelector('div').classList.add('scale-95');
      setTimeout(() => { // Hide after animation
        msgBox.classList.add('hidden');
      }, 300);
    }

    // --- Page Navigation Function ---
    // Controls which content page is visible
    function showPage(pageId, clickedButton = null) {
      const allPageContents = document.querySelectorAll('.page-content');
      allPageContents.forEach(page => {
        page.classList.add('hidden'); // Hide all pages
      });

      const targetPage = document.getElementById(pageId);
      if (targetPage) {
        targetPage.classList.remove('hidden'); // Show target page

        // Update active tab styling
        document.querySelectorAll('.btn-tab').forEach(btn => {
          btn.classList.remove('active');
        });
        if (clickedButton) {
          clickedButton.classList.add('active');
        } else { // Handle initial load or direct function calls
            const defaultButton = document.querySelector(`.btn-tab[data-page-id="${pageId}"]`);
            if (defaultButton) defaultButton.classList.add('active');
        }

        // Specific actions for certain pages when they become visible
        if (pageId === 'inventory-settings-page') {
          renderStockPanelInputs(); 
        } else if (pageId === 'restock-page') {
          renderRestockPanelInputs(); 
        } else if (pageId === 'history-charts-page') {
          showRecentHistory(); 
          generatePieChart();
          generateSalesTrendChart();
        } else if (pageId === 'daily-data-page') {
          // Check for low stock on daily data page load
          checkLowStockAndDisplayWarning();
        }
      }
    }

    // --- Inventory Management Panel Functions ---

    // Renders input fields for setting raw material inventory
    function renderStockPanelInputs() {
      const container = document.getElementById("stock-inputs-container"); 
      container.innerHTML = materials.map(m => `
        <div>
          <label for="stock-${m.name}" class="block text-sm font-medium text-gray-700 mb-1">${m.name}（${m.unit}）</label>
          <input type="number" step="0.01" id="stock-${m.name}" class="input-field" value="${inventory[m.name] || 0}" />
          <label for="threshold-${m.name}" class="block text-xs font-medium text-gray-500 mt-1">最低库存 (${m.unit})</label>
          <input type="number" step="0.01" id="threshold-${m.name}" class="input-field text-xs" value="${m.lowStockThreshold || 0}" />
        </div>
      `).join('');
    }

    // Save raw material inventory and thresholds
    function saveInventory() {
      materials.forEach(m => {
        inventory[m.name] = parseFloat(document.getElementById("stock-" + m.name).value) || 0;
        const thresholdInput = document.getElementById(`threshold-${m.name}`);
        if(thresholdInput) {
            m.lowStockThreshold = parseFloat(thresholdInput.value) || 0;
        }
      });
      localStorage.setItem("inventory", JSON.stringify(inventory));
      showMessageBox("原材料库存及预警阈值已更新！", 'success');
      showPage('daily-data-page'); // Return to daily data page after saving
    }

    // --- Raw Material Restock Functions ---

    // Renders input fields for raw material restock
    function renderRestockPanelInputs() {
      const container = document.getElementById("restock-inputs-container"); 
      container.innerHTML = materials.map(m => `
        <div>
          <label for="restock-${m.name}" class="block text-sm font-medium text-gray-700 mb-1">${m.name}（${m.unit}）</label>
          <input type="number" step="0.01" id="restock-${m.name}" class="input-field" value="0" placeholder="请输入进货量" />
        </div>
      `).join('');
    }

    // Confirm raw material restock
    function confirmRestock() {
      let restockSuccessful = true;
      materials.forEach(m => {
        const restockAmount = parseFloat(document.getElementById("restock-" + m.name).value) || 0;
        if (isNaN(restockAmount) || restockAmount < 0) {
            showMessageBox(`请输入有效的 ${m.name} 进货量（非负数字）！`, 'warning');
            restockSuccessful = false;
            return; 
        }
        inventory[m.name] = (inventory[m.name] || 0) + restockAmount; 
      });

      if (restockSuccessful) {
        localStorage.setItem("inventory", JSON.stringify(inventory)); 
        showMessageBox("原材料进货已完成！", 'success');
        showPage('daily-data-page'); // Return to daily data page after restocking
      }
    }

    // --- Current Day Input Persistence ---
    function saveCurrentInputs() {
        const currentInputs = {};
        flavors.forEach(f => {
            currentInputs[`${f}-start-10am`] = document.getElementById(`${f}-start-10am`).value;
            currentInputs[`${f}-end-8pm`] = document.getElementById(`${f}-end-8pm`).value;
            currentInputs[`${f}-yesterday-made-today-available`] = document.getElementById(`${f}-yesterday-made-today-available`).value;
            currentInputs[`${f}-theoretical-production-for-raw-materials`] = document.getElementById(`${f}-theoretical-production-for-raw-materials`).value;
            currentInputs[`${f}-taste-cups`] = document.getElementById(`${f}-taste-cups`).value;
        });
        currentInputs['note'] = document.getElementById('note').value;
        currentInputs['currentDate'] = document.getElementById('report-date').value; 
        localStorage.setItem('currentDayInputs', JSON.stringify(currentInputs));
    }

    function loadCurrentInputs() {
        const savedInputs = JSON.parse(localStorage.getItem('currentDayInputs') || '{}');
        flavors.forEach(f => {
            if (savedInputs[`${f}-start-10am`]) document.getElementById(`${f}-start-10am`).value = savedInputs[`${f}-start-10am`];
            if (savedInputs[`${f}-end-8pm`]) document.getElementById(`${f}-end-8pm`).value = savedInputs[`${f}-end-8pm`];
            if (savedInputs[`${f}-yesterday-made-today-available`]) document.getElementById(`${f}-yesterday-made-today-available`).value = savedInputs[`${f}-yesterday-made-today-available`];
            if (savedInputs[`${f}-theoretical-production-for-raw-materials`]) document.getElementById(`${f}-theoretical-production-for-raw-materials`).value = savedInputs[`${f}-theoretical-production-for-raw-materials`];
            if (savedInputs[`${f}-taste-cups`]) document.getElementById(`${f}-taste-cups`).value = savedInputs[`${f}-taste-cups`];
        });
        if (savedInputs['note']) document.getElementById('note').value = savedInputs['note'];
        
        const dateInput = document.getElementById('report-date');
        if (savedInputs['currentDate']) {
            dateInput.value = savedInputs['currentDate'];
        } else {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
        }

        document.querySelectorAll('.input-field').forEach(input => {
            input.addEventListener('input', saveCurrentInputs);
        });
        document.getElementById('note').addEventListener('input', saveCurrentInputs);
        document.getElementById('report-date').addEventListener('change', saveCurrentInputs); 
    }

    // --- Main Interface Rendering Function ---

    // Render the main data input table
    function renderTable() {
      const app = document.getElementById("app");
      let html = `
      <table class="w-full table-auto text-sm border-collapse rounded-lg overflow-hidden">
        <thead class="bg-blue-100 text-blue-800">
          <tr>
            <th class="table-header">口味</th>
            <th class="table-header">今日10点库存 (杯)</th>
            <th class="table-header">今日20点库存 (杯)</th>
            <th class="table-header">昨日新做<br/>(今日可售) (杯)</th>
            <th class="table-header">今日理论制作<br/>(原材料计算用) (杯)</th>
            <th class="table-header">今日试吃消耗 (试吃杯)</th>
          </tr>
        </thead>
        <tbody>
          ${flavors.map(f => `
            <tr class="hover:bg-gray-50">
              <td class="table-data font-semibold text-gray-700">${f}</td>
              <td class="table-data"><input type="number" step="0.1" class="input-field" id="${f}-start-10am" value="0" placeholder="例如: 50.0" /></td>
              <td class="table-data"><input type="number" step="0.1" class="input-field" id="${f}-end-8pm" value="0" placeholder="例如: 30.0" /></td>
              <td class="table-data"><input type="number" step="0.1" class="input-field" id="${f}-yesterday-made-today-available" value="0" placeholder="例如: 20.0" /></td>
              <td class="table-data"><input type="number" step="0.1" class="input-field" id="${f}-theoretical-production-for-raw-materials" value="0" placeholder="例如: 60.0" /></td>
              <td class="table-data"><input type="number" step="1" class="input-field" id="${f}-taste-cups" value="0" placeholder="例如: 100" /></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      <div class="mt-4 p-4 bg-gray-100 rounded-lg">
        <label for="note" class="font-semibold text-gray-700 block mb-2">备注：</label>
        <input id="note" class="input-field w-full" placeholder="如：下雨天、节假日、促销等" />
      </div>`;
      app.innerHTML = html;
      loadCurrentInputs(); // Load previously saved inputs
    }

    // --- Main Calculation Logic ---

    // Save and calculate daily data
    function saveAndCalculate() {
      // Backup current state for restore
      localStorage.setItem("previousInventory", localStorage.getItem("inventory"));
      localStorage.setItem("previousSaleHistory", localStorage.getItem("saleHistory"));

      let totalCustomerSales = 0; 
      let totalIncome = 0;        
      let totalTheoreticalProductionForRawMaterials = 0; 

      const flavorStats = {};
      const matUse = {};
      materials.forEach(m => matUse[m.name] = 0); 

      let inputError = false; 
      flavors.forEach(f => {
        const start_stock_10am = parseFloat(document.getElementById(`${f}-start-10am`).value);
        const end_stock_8pm = parseFloat(document.getElementById(`${f}-end-8pm`).value);
        const yesterday_made_today_available = parseFloat(document.getElementById(`${f}-yesterday-made-today-available`).value); 
        const theoretical_production_for_raw_materials = parseFloat(document.getElementById(`${f}-theoretical-production-for-raw-materials`).value); 
        const taste_test_cups_used = parseFloat(document.getElementById(`${f}-taste-cups`).value);     

        if (isNaN(start_stock_10am) || isNaN(end_stock_8pm) || isNaN(yesterday_made_today_available) || isNaN(theoretical_production_for_raw_materials) || isNaN(taste_test_cups_used)) {
            inputError = true;
            return; 
        }

        const taste_test_equivalent_normal_cups = taste_test_cups_used / 50;
        const daily_customer_sales = (start_stock_10am + yesterday_made_today_available - end_stock_8pm) - taste_test_equivalent_normal_cups;
        const final_sales = Math.max(0, daily_customer_sales); 

        const price = f === '原味' ? 8 : 9.9;
        const income = final_sales * price;

        totalCustomerSales += final_sales;
        totalIncome += income;

        flavorStats[f] = {
            售出杯数: final_sales,
            单价: price.toFixed(2),
            销售额: income.toFixed(2),
            今日理论制作: theoretical_production_for_raw_materials,
            试吃杯数: taste_test_cups_used 
        };

        if (f === '草莓味') matUse['草莓味果味粉'] += theoretical_production_for_raw_materials * 181.5 / 50;
        if (f === '百香果味') matUse['百香果味果味粉'] += theoretical_production_for_raw_materials * 181.5 / 50;
        if (f === '蔓越莓味') matUse['蔓越莓味果味粉'] += theoretical_production_for_raw_materials * 181.5 / 50;
        
        matUse['酸奶盒'] += theoretical_production_for_raw_materials; 
        matUse['酸奶盒盖'] += theoretical_production_for_raw_materials; 

        matUse['试吃杯'] += taste_test_cups_used; 

        totalTheoreticalProductionForRawMaterials += theoretical_production_for_raw_materials;
      });

      if (inputError) {
          showMessageBox("请输入有效的数字！", 'error');
          return; 
      }

      matUse['牛奶'] += totalTheoreticalProductionForRawMaterials * materials.find(m => m.name === '牛奶').per50 / 50;
      matUse['淡奶油'] += totalTheoreticalProductionForRawMaterials * materials.find(m => m.name === '淡奶油').per50 / 50;
      matUse['炼乳'] += totalTheoreticalProductionForRawMaterials * materials.find(m => m.name === '炼乳').per50 / 50;
      matUse['奶皮粉'] += totalTheoreticalProductionForRawMaterials * materials.find(m => m.name === '奶皮粉').per50 / 50;
      matUse['益生菌粉'] += totalTheoreticalProductionForRawMaterials * materials.find(m => m.name === '益生菌粉').per50 / 50;


      let resultHtml = `<h2 class='text-xl font-bold text-blue-700 mb-4'>📊 今日销售汇总与原材料消耗</h2>`;
      resultHtml += `<div class="bg-white p-4 rounded-lg shadow-inner mb-4">
                        <h3 class='text-lg font-semibold text-blue-600 mb-2'>销售情况</h3>
                        <ul class='list-disc pl-6 text-gray-800'>`;
      for (const f in flavorStats) {
        resultHtml += `<li>${f}：售出 <span class="font-bold text-lg">${flavorStats[f].售出杯数.toFixed(1)}</span> 杯，单价 ${flavorStats[f].单价} 元，营业额 <span class="font-bold text-lg">${flavorStats[f].销售额}</span> 元</li>`;
        resultHtml += `<li class="ml-4 text-gray-600">今日理论制作：${flavorStats[f].今日理论制作} 杯，试吃：${flavorStats[f].试吃杯数} 试吃杯</li>`;
      }
      resultHtml += `</ul><p class='mt-4 font-extrabold text-blue-800 text-xl'>总售出：${totalCustomerSales.toFixed(1)} 杯，总收入：${totalIncome.toFixed(2)} 元</p></div>`;

      resultHtml += `<div class="bg-white p-4 rounded-lg shadow-inner">
                        <h3 class='text-lg font-semibold text-blue-600 mb-2'>原材料消耗及库存变化</h3>
                        <ul class='list-disc pl-6 text-gray-800'>`;
      const consumptionToday = [];
      let lowStockAlerts = []; 

      materials.forEach(m => {
        const used = matUse[m.name];
        const remain = (inventory[m.name] || 0) - used; 
        const warnClass = remain < 0 ? 'text-red-600 font-bold' : 'text-green-700'; 
        resultHtml += `<li>${m.name}：消耗 <span class="font-bold">${used.toFixed(2)}</span> ${m.unit}, 
                        <span class="${warnClass}">剩余 ${remain.toFixed(2)} ${m.unit}</span></li>`;
        inventory[m.name] = remain; 

        consumptionToday.push({ 原材料: m.name, 单位: m.unit, 消耗量: used.toFixed(2), 剩余库存: remain.toFixed(2) });
      });
      resultHtml += `</ul></div>`;

      document.getElementById("result").innerHTML = resultHtml;

      localStorage.setItem("inventory", JSON.stringify(inventory)); 

      const date = document.getElementById('report-date').value; 
      const note = document.getElementById("note").value || "无"; 

      const history = JSON.parse(localStorage.getItem("saleHistory") || "[]");
      history.push({ 
        日期: date, 
        售出总量: totalCustomerSales.toFixed(1), 
        总营业额: totalIncome.toFixed(2), 
        备注: note, 
        明细: flavorStats,
        原材料消耗: consumptionToday
      });
      localStorage.setItem("saleHistory", JSON.stringify(history)); 

      showMessageBox("计算完成，数据已保存！", 'success');
      
      // Update low stock warning on daily data page
      checkLowStockAndDisplayWarning(); 
      // Clear inputs after successful calculation and saving
      clearInputFields(false); // Do not show "输入已清空" message
    }

    // --- Check Low Stock and Display Warning ---
    function checkLowStockAndDisplayWarning() {
        const lowStockList = document.getElementById('low-stock-list');
        const lowStockWarningDiv = document.getElementById('low-stock-warning');
        let alertsHtml = '';
        let hasLowStock = false;

        materials.forEach(m => {
            const currentStock = inventory[m.name] || 0;
            if (currentStock < m.lowStockThreshold) {
                alertsHtml += `<li>${m.name}：目前剩余 ${currentStock.toFixed(2)} ${m.unit}，低于预警值 ${m.lowStockThreshold} ${m.unit}。</li>`;
                hasLowStock = true;
            }
        });

        if (hasLowStock) {
            lowStockList.innerHTML = alertsHtml;
            lowStockWarningDiv.classList.remove('hidden');
        } else {
            lowStockWarningDiv.classList.add('hidden');
            lowStockList.innerHTML = '';
        }
    }


    // --- Historical Record Display Function ---

    // Display recent sales history
    function showRecentHistory() {
      const history = JSON.parse(localStorage.getItem("saleHistory") || "[]");
      const summaryDiv = document.getElementById("summary");
      if (!history.length) {
        summaryDiv.innerHTML = "<p class='text-center text-gray-500'>暂无销售记录</p>";
        return;
      }

      let html = `<h2 class="text-xl font-bold text-gray-700 mb-4">📊 历史销售记录</h2>`;
      html += `<div class="overflow-x-auto rounded-lg shadow-md border border-gray-300">
                <table class="w-full table-auto text-sm border-collapse">
                  <thead class="bg-gray-200 text-gray-700">
                    <tr>
                      <th class="table-header">日期</th>
                      <th class="table-header">口味</th>
                      <th class="table-header">售出杯数</th>
                      <th class="table-header">单价</th>
                      <th class="table-header">销售额</th>
                      <th class="table-header">今日理论制作</th>
                      <th class="table-header">试吃杯数</th>
                      <th class="table-header">备注</th>
                    </tr>
                  </thead>
                  <tbody>`;
      history.slice().reverse().forEach(r => {
        let firstRow = true;
        for (const f of flavors) {
          if (r.明细 && r.明细[f]) {
            html += `<tr class="border-t border-gray-200 hover:bg-gray-50">
              <td class='table-data ${firstRow ? 'font-semibold' : ''}'>${firstRow ? r.日期 : ''}</td>
              <td class='table-data'>${f}</td>
              <td class='table-data'>${r.明细[f].售出杯数.toFixed(1)}</td>
              <td class='table-data'>${r.明细[f].单价}</td>
              <td class='table-data'>${r.明细[f].销售额}</td>
              <td class='table-data'>${r.明细[f].今日理论制作 || '0'}</td>
              <td class='table-data'>${r.明细[f].试吃杯数 || '0'}</td>
              <td class='table-data ${firstRow ? 'font-semibold' : ''}'>${firstRow ? (r.备注 || '无') : ''}</td>
            </tr>`;
            firstRow = false;
          }
        }
        html += `<tr class="bg-gray-100 font-bold">
                    <td class="table-data" colspan="2">总计</td>
                    <td class="table-data">${r.售出总量}</td>
                    <td class="table-data"></td>
                    <td class="table-data">${r.总营业额}</td>
                    <td class="table-data" colspan="3"></td>
                  </tr>`;
      });
      html += `</tbody></table></div>`;
      summaryDiv.innerHTML = html;
    }


    // --- Chart Generation Functions ---

    function generatePieChart() {
      const history = JSON.parse(localStorage.getItem("saleHistory") || "[]");
      const noDataMessage = document.getElementById('no-pie-data-message');
      const ctx = document.getElementById("flavorPieChart").getContext("2d");

      if (!history.length) {
        if (pieChartInstance) pieChartInstance.destroy(); 
        noDataMessage.classList.remove('hidden'); // Show no data message
        return;
      }
      noDataMessage.classList.add('hidden'); // Hide no data message

      const salesByFlavor = {};
      flavors.forEach(f => salesByFlavor[f] = 0); 

      history.forEach(r => {
        for (let f in r.明细) {
          salesByFlavor[f] += Number(r.明细[f].售出杯数 || 0);
        }
      });

      if (pieChartInstance) {
        pieChartInstance.destroy();
      }

      pieChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: flavors, 
          datasets: [{
            data: flavors.map(f => salesByFlavor[f]), 
            backgroundColor: [
              '#f87171', '#facc15', '#34d399', '#60a5fa' 
            ],
            borderColor: '#fff', 
            borderWidth: 2, 
          }]
        },
        options: {
          responsive: true, 
          maintainAspectRatio: true, 
          plugins: {
            legend: {
              position: 'top', 
              labels: {
                font: { size: 14 }
              }
            },
            title: {
              display: true,
              text: '各口味累计销量分布', 
              font: { size: 18, weight: 'bold' },
              color: '#374151' 
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  if (label) label += ': ';
                  if (context.parsed !== null) label += context.parsed.toFixed(1) + ' 杯'; 
                  return label;
                }
              }
            }
          }
        }
      });
    }

    function generateSalesTrendChart() {
        const history = JSON.parse(localStorage.getItem("saleHistory") || "[]");
        const noDataMessage = document.getElementById('no-trend-data-message');
        const ctx = document.getElementById("salesTrendChart").getContext("2d");

        if (!history.length) {
            if (salesTrendChartInstance) salesTrendChartInstance.destroy();
            noDataMessage.classList.remove('hidden'); // Show no data message
            return;
        }
        noDataMessage.classList.add('hidden'); // Hide no data message

        const dailySales = {};
        history.forEach(r => {
            const date = r.日期;
            const totalSales = parseFloat(r.总营业额 || 0);
            dailySales[date] = (dailySales[date] || 0) + totalSales;
        });

        const sortedDates = Object.keys(dailySales).sort();
        const salesData = sortedDates.map(date => dailySales[date]);

        if (salesTrendChartInstance) {
            salesTrendChartInstance.destroy();
        }

        salesTrendChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedDates,
                datasets: [{
                    label: '每日总销售额 (元)',
                    data: salesData,
                    borderColor: '#4299e1', 
                    backgroundColor: 'rgba(66, 153, 225, 0.2)', 
                    fill: true,
                    tension: 0.3, 
                    pointBackgroundColor: '#4299e1',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#4299e1',
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false 
                    },
                    title: {
                        display: true,
                        text: '每日总销售额趋势',
                        font: { size: 18, weight: 'bold' },
                        color: '#374151'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) label += `${context.parsed.y.toFixed(2)} 元`;
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: '日期'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '销售额 (元)'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }


    // --- PDF Export Function ---

    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4'); 
      
      const exportButton = document.getElementById('exportPdfButton');
      exportButton.disabled = true;
      exportButton.textContent = '📄 导出中...';

      const target = document.getElementById('daily-data-page'); 

      const allPageContents = document.querySelectorAll('.page-content');
      allPageContents.forEach(page => {
          if (page.id !== 'daily-data-page') { 
              page.classList.add('hidden'); 
          }
      });
      const globalNavButtons = document.querySelectorAll('.flex.flex-wrap.justify-center.gap-3.mb-6 button'); 
      globalNavButtons.forEach(btn => btn.classList.add('hidden'));

      // Temporarily hide elements not needed in the export, e.g., welcome message, low stock warning
      document.getElementById('daily-data-welcome-message').classList.add('hidden');
      document.getElementById('low-stock-warning').classList.add('hidden');


      try {
        await html2canvas(target, { 
          scale: 2, 
          useCORS: true, 
          logging: false 
        }).then(canvas => {
          const imgData = canvas.toDataURL('image/png'); 
          const imgProps = pdf.getImageProperties(imgData);
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width; 

          pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        });

        pdf.save('酸奶管理系统_日报_' + document.getElementById('report-date').value + '.pdf'); 
        showMessageBox("日报已导出为PDF！", 'success');
      } catch (error) {
        console.error("PDF Export failed:", error);
        showMessageBox("PDF 导出失败，请重试！", 'error');
      } finally {
        allPageContents.forEach(page => {
            if (page.id !== 'daily-data-page') {
                page.classList.add('hidden'); 
            } else {
                page.classList.remove('hidden'); 
            }
        });
        globalNavButtons.forEach(btn => btn.classList.remove('hidden')); 
        
        // Restore welcome message and low stock warning visibility based on state
        document.getElementById('daily-data-welcome-message').classList.remove('hidden');
        checkLowStockAndDisplayWarning(); // Re-evaluate and show if needed

        exportButton.disabled = false;
        exportButton.textContent = '📄 导出当日报表 (PDF)';
      }
    }

    // --- State Restore Function ---

    // Restore to previous operation state
    function restorePreviousState() {
      const previousInventory = localStorage.getItem("previousInventory");
      const previousHistory = localStorage.getItem("previousSaleHistory");

      if (!previousInventory && !previousHistory) {
        showMessageBox("没有可还原的数据。", 'info');
        return;
      }

      document.getElementById('custom-message-text').innerText = "确定要还原为上一步吗？这将撤销当前更改并重新加载页面。";
      document.getElementById('message-icon').innerHTML = '↩️';
      document.getElementById('message-icon').style.color = '#F59E0B'; // Yellowish for warning
      document.getElementById('custom-message-box').classList.remove('hidden');
      setTimeout(() => { 
        document.getElementById('custom-message-box').classList.remove('opacity-0');
        document.getElementById('custom-message-box').querySelector('div').classList.remove('scale-95');
      }, 10);
      
      const confirmButton = document.querySelector('#custom-message-box button');
      confirmButton.onclick = null; 
      confirmButton.onclick = () => {
        if (previousInventory) {
          localStorage.setItem("inventory", previousInventory);
        } else {
          localStorage.removeItem("inventory"); 
        }
        if (previousHistory) {
          localStorage.setItem("saleHistory", previousHistory);
        } else {
          localStorage.removeItem("saleHistory"); 
        }
        localStorage.removeItem('currentDayInputs'); 
        location.reload(); 
      };
    }
    
    // --- Clear Input Fields Function ---
    function clearInputFields(showMessage = true) {
        flavors.forEach(f => {
            document.getElementById(`${f}-start-10am`).value = 0;
            document.getElementById(`${f}-end-8pm`).value = 0;
            document.getElementById(`${f}-yesterday-made-today-available`).value = 0;
            document.getElementById(`${f}-theoretical-production-for-raw-materials`).value = 0;
            document.getElementById(`${f}-taste-cups`).value = 0;
        });
        document.getElementById("note").value = "";
        localStorage.removeItem('currentDayInputs'); 
        if (showMessage) {
          showMessageBox("输入已清空！", 'info');
        }
    }


    // --- Execute on Page Load ---
    window.onload = () => {
      renderTable(); 
      showPage('daily-data-page'); 
    };
  </script>

  <style>
    /* Tailwind CSS base styles */
    body {
      font-family: 'Inter', sans-serif;
    }
    .btn-primary {
      @apply px-5 py-2 rounded-lg font-bold text-white transition duration-200 ease-in-out transform hover:scale-105 shadow-md;
    }
    .input-field {
      @apply w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out;
    }
    .table-header {
      @apply px-2 py-3 border-b-2 border-blue-200 text-left text-xs font-semibold uppercase tracking-wider;
    }
    .table-data {
      @apply px-2 py-2 border-b border-gray-200 text-gray-900;
    }
    .page-content {
      @apply p-4 border border-gray-200 rounded-lg bg-white;
    }
    .btn-tab {
        @apply px-4 py-2 rounded-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-200 ease-in-out;
    }
    .btn-tab.active {
        @apply bg-blue-600 text-white shadow-md;
    }
  </style>
</body>
</html>
